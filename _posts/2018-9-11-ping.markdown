---
layout:     post
title:      "ä¸€ä¸ªç½‘ç»œæµ‹è¯•å·¥å…·"
subtitle:   " \" simplePingæºç è§£æå’Œå®Œå–„\""
date:       2018-09-11 18:00:00
author:     "QD"
header-img: "img/post-bg-2015.jpg"
catalog: true
tags:
    - iOS
---

> åŸºæœ¬éƒ½æ˜¯c çœ‹çš„æˆ‘ååˆ†éš¾äº§

## ä½¿ç”¨
``` swift
let pinger = SimplePing(hostName: self.hostName)
self.pinger = pinger
pinger.delegate = self
pinger.start()

//ç„¶åä»£ç†å›è°ƒ
func simplePing(pinger: SimplePing, didStartWithAddress address: NSData) {
    self.pinger!.send(with: nil)
}
func simplePing(pinger: SimplePing, didReceivePingResponsePacket packet: NSData, sequenceNumber: UInt16) {
    NSLog("#%u received, size=%zu", sequenceNumber, packet.length)
}
```

## æ€»è§ˆ

å¯¹äºç½‘ç»œæµ‹è¯•æˆ‘ä»¬çŸ¥é“pingå‘½ä»¤ï¼Œæ¥æµ‹è¯•ç½‘ç»œè¿é€šæ€§ã€‚è‹¹æœä¹Ÿç»™å‡ºäº†ä¸€ä¸ªå°è£…äº†ä¸€ä¸ªç®€å•çš„pingå‡½æ•°ã€‚æˆ‘ä»¬å»è§£è¯»ä¸€ä¸‹è¿™ä¸ªå·¥å…·å¹¶å»å®Œå–„å®ƒã€‚

**æ€»ä½“æµç¨‹**
![ping æµç¨‹æ€»è§ˆ](/img/in-post/ping/ping-1.png)

## è§£æhostname

**è§£æhostæµç¨‹å›¾**
![host è§£ææµç¨‹](/img/in-post/ping/ping-2.png)

``` swift
// 1 å¸¸è§host
self.host = (CFHostRef) CFAutorelease( CFHostCreateWithName(NULL, (__bridge CFStringRef) self.hostName) );
assert(self.host != NULL);
// 2 æŒ‡å®šhost å¤„ç†ä»£ç†
CFHostSetClient(self.host, HostResolveCallback, &context);

CFHostScheduleWithRunLoop(self.host, CFRunLoopGetCurrent(), kCFRunLoopDefaultMode);
//3 å¼€å§‹å¤„ç†
success = CFHostStartInfoResolution(self.host, kCFHostAddresses, &streamError);
if ( ! success ) {
[self didFailWithHostStreamError:streamError];
}
```
è¿™é‡Œè¦æ³¨æ„çš„æ˜¯ï¼Œ`CFHostStartInfoResolution` å¯ä»¥ä¸ç”¨æ‰§è¡Œ`client`å’Œ`runloop` ç›´æ¥åŒæ­¥æ‰§è¡Œã€‚è¿™æ ·ä¼šé˜»å¡çº¿ç¨‹ï¼Œç›´æ¥å°†ç»“æœå­˜æ”¾åˆ°`host` å®ä¾‹ä¸­

è‹¹æœè¿™é‡Œæœ‰ä¸ª`addressStyle` çš„å±æ€§ è®©ç”¨æˆ·å»æŒ‡å®šipv4è¿˜æ˜¯ipv6 ç„¶åæ ¹æ®è¿™ä¸ªå±æ€§å»å¤„ç†hostã€‚è¿™ä¸ªå¤„ç†æ„Ÿè§‰æœ‰ç‚¹å¤šä½™ã€‚

```swift
// ......
addresses = (__bridge NSArray *) CFHostGetAddressing(self.host, &resolved);
// ......
const struct sockaddr * addrPtr;
addrPtr = (const struct sockaddr *) address.bytes;
```
è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹
`CFHostGetAddressing` è¿™ä¸ªæ–¹æ³•ç”¨æ¥è·å–åœ°å€ä¿¡æ¯ï¼Œè·å–çš„æ˜¯æ˜¯ä¸€ä¸ªæ•°ç»„åŒ…å«çš„`sockaddr`ç»“æ„ä½“
```swift
/*
* [XSI] Structure used by kernel to store most addresses.
*/
struct sockaddr {
__uint8_t    sa_len;        /* total length */
sa_family_t    sa_family;    /* [XSI] address family */
char        sa_data[14];    /* [XSI] addr value (actually larger) */
};
```
è¿™é‡Œæœ‰3ä¸ªæ•°æ® é•¿åº¦ ç±»å‹ ä»¥åŠ å…·ä½“æ•°æ®ã€‚ æˆ‘ä»¬æ‹¿åˆ°è¿™ä¸ª `sockaddr` å°±çŸ¥é“ç›®æ ‡ä¸»æœºçš„åœ°å€äº†ã€‚

## åˆ›å»ºsocket
è¿™é‡Œå’Œhost å·®ä¸å¤šå¸¸è§socketå¯¹è±¡ ç„¶åæ”¾åˆ°runloopä¸­
```swift
// Wrap it in a CFSocket and schedule it on the runloop.

self.socket = (CFSocketRef) CFAutorelease( CFSocketCreateWithNative(NULL, fd, kCFSocketReadCallBack, SocketReadCallback, &context) );

// The socket will now take care of cleaning up our file descriptor.
rls = CFSocketCreateRunLoopSource(NULL, self.socket, 0);

CFRunLoopAddSource(CFRunLoopGetCurrent(), rls, kCFRunLoopDefaultMode);
```

åˆ°ç°åœ¨ ---- `start` çš„å‡†å¤‡å·¥ä½œå·²ç»å®Œæˆã€‚ ä¸‹é¢å¼€å§‹pingè¯·æ±‚
## å‘é€pingè¯·æ±‚
åœ¨è§£ææºç ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆè¦çŸ¥é“pingçš„åŸç†
> ICMP :äº’è”ç½‘æ§åˆ¶æ¶ˆæ¯åè®®ï¼ˆè‹±è¯­ï¼šInternet Control Message Protocolï¼Œç¼©å†™ï¼šICMPï¼‰æ˜¯äº’è”ç½‘åè®®æ—çš„æ ¸å¿ƒåè®®ä¹‹ä¸€ã€‚å®ƒç”¨ äºTCP/IPç½‘ç»œä¸­å‘é€æ§åˆ¶æ¶ˆæ¯ï¼Œæä¾›å¯èƒ½å‘ç”Ÿåœ¨é€šä¿¡ç¯å¢ƒä¸­çš„å„ç§é—®é¢˜åé¦ˆï¼Œé€šè¿‡è¿™äº›ä¿¡æ¯ï¼Œä½¿ç®¡ç†è€…å¯ä»¥å¯¹æ‰€å‘ç”Ÿçš„é—®é¢˜ä½œå‡º è¯Š æ–­ï¼Œç„¶åé‡‡å–é€‚å½“çš„æªæ–½è§£å†³ã€‚
> ICMP [1]ä¾é IPæ¥å®Œæˆå®ƒçš„ä»»åŠ¡ï¼Œå®ƒæ˜¯IPçš„ä¸»è¦éƒ¨åˆ†ã€‚å®ƒä¸ä¼ è¾“åè®®ï¼ˆå¦‚TCPå’ŒUDPï¼‰æ˜¾è‘—ä¸åŒï¼šå®ƒä¸€èˆ¬ä¸ç”¨äºåœ¨ä¸¤ç‚¹é—´ä¼ è¾“æ•°> æ®ã€‚å®ƒé€šå¸¸ä¸ç”±ç½‘ç»œç¨‹åºç›´æ¥ä½¿ç”¨ï¼Œé™¤äº†pingå’Œtracerouteè¿™ä¸¤ä¸ªç‰¹åˆ«çš„ä¾‹å­ã€‚ IPv4ä¸­çš„ICMPè¢«ç§°ä½œICMPv4ï¼ŒIPv6ä¸­çš„ICMPåˆ™è¢«ç§°ä½œICMPv6ã€‚

![æŠ¥æ–‡ç»“æ„](/img/in-post/ping/ping-3.png)

è¿™é‡Œæºç ä¸­éƒ½å®šä¹‰
```swift
struct IPv4Header //ipå¤´
static uint16_t in_cksum(const void *buffer, size_t bufferLen) // é»˜è®¤çš„æ ¡éªŒæ–¹æ³•

struct ICMPHeader {
uint8_t     type;
uint8_t     code;
uint16_t    checksum;
uint16_t    identifier;
uint16_t    sequenceNumber;
// data...
};

enum {
ICMPv4TypeEchoRequest = 8,          ///< The ICMP `type` for a ping request; in this case `code` is always 0.
ICMPv4TypeEchoReply   = 0           ///< The ICMP `type` for a ping response; in this case `code` is always 0.
};

enum {
ICMPv6TypeEchoRequest = 128,        ///< The ICMP `type` for a ping request; in this case `code` is always 0.
ICMPv6TypeEchoReply   = 129         ///< The ICMP `type` for a ping response; in this case `code` is always 0.
};

```

è¿™è¾¹æˆ‘ä»¬é‡ç‚¹çœ‹çš„å°±æ˜¯ icmpçš„åŒ…å¤´ç»“æ„ ä»¥åŠipv4 ipv6 typeçš„åŒºåˆ«ã€‚

å‘é€pingè¯·æ±‚æ˜¯è‹¹æœæ”¾åœ¨æºç  å¤–é¢æ‰‹åŠ¨è°ƒç”¨çš„ ã€‚è¿™æ ·å¯æ‰©äº§æ€§æ›´é«˜äº†ï¼Œä¹Ÿæ›´éº»çƒ¦äº†ğŸ˜‚

```swift
- (void)sendPingWithData:(NSData *)data 
```

**ç¬¬ä¸€æ­¥**
å¡«å……æ•°æ® è¿™éƒ¨åˆ†å…¶å®æ²¡å•¥ç”¨ï¼Œå°±æ˜¯æ›´å¥½è¯†åˆ«è‡ªå·±çš„æ•°æ®ã€‚å¦‚æœæ²¡æœ‰è¿™ä¸€æ­¥çš„è¯ï¼Œç³»ç»Ÿåº”ä¼šè‡ªåŠ¨å¸®æˆ‘ä»¬å¡«å……åˆ°64bytesçš„
```swift
payload = data;
if (payload == nil) {
payload = [[NSString stringWithFormat:@"%28zd bottles of beer on the wall", (ssize_t) 99 - (size_t) (self.nextSequenceNumber % 100) ] dataUsingEncoding:NSASCIIStringEncoding];
assert(payload != nil);

// Our dummy payload is sized so that the resulting ICMP packet, including the ICMPHeader, is 
// 64-bytes, which makes it easier to recognise our packets on the wire.

assert([payload length] == 56);
}
```
**ç¬¬äºŒæ­¥**
ç»„è£…æ•°æ®
```swift
packet = [self pingPacketWithType:ICMPv4TypeEchoRequest payload:payload requiresChecksum:YES];
.....


NSMutableData *         packet;
ICMPHeader *            icmpPtr;

packet = [NSMutableData dataWithLength:sizeof(*icmpPtr) + payload.length];
assert(packet != nil);

icmpPtr = packet.mutableBytes;
icmpPtr->type = type;
icmpPtr->code = 0;
icmpPtr->checksum = 0;
icmpPtr->identifier     = OSSwapHostToBigInt16(self.identifier);
icmpPtr->sequenceNumber = OSSwapHostToBigInt16(self.nextSequenceNumber);
memcpy(&icmpPtr[1], [payload bytes], [payload length]);

if (requiresChecksum) {
// The IP checksum routine returns a 16-bit number that's already in correct byte order 
// (due to wacky 1's complement maths), so we just put it into the packet as a 16-bit unit.

icmpPtr->checksum = in_cksum(packet.bytes, packet.length);
}

```
è¿™ä¸€éƒ¨åˆ† è¦æ³¨æ„çš„æ˜¯ ipv4 å’Œ ipv6çš„æ ¡éªŒå€¼åœ°æ–¹ä¸ä¸€æ ·ã€‚ ipv6 æ˜¯ä¸éœ€è¦æ ¡éªŒçš„ï¼Œ åé¢éªŒè¯æ•°æ®ä¹Ÿè¦åŒºåˆ†

**ç¬¬ä¸‰æ­¥**
å‘é€æ•°æ®
è¿™ä¸€æ­¥ æ˜¯åŒæ­¥ æ ¹æ®è¿”å›çš„ç»“æœæ¥åˆ¤æ–­æ•°æ® å›è°ƒå‘é€æˆåŠŸè¿˜æ˜¯å¤±è´¥
```
bytesSent = sendto(
CFSocketGetNative(self.socket),
packet.bytes,
packet.length, 
0,
self.hostAddress.bytes, 
(socklen_t) self.hostAddress.length
);
```

**ç¬¬å››æ­¥**
## å›è°ƒè§£ææ•°æ®
 ```swift
- (void)readData {
    .....
    bytesRead = recvfrom(CFSocketGetNative(self.socket), buffer, kBufferSize, 0, (struct sockaddr *) &addr, &addrLen);
    ....
    packet = [NSMutableData dataWithBytes:buffer length:(NSUInteger) bytesRead];
    ...
    éªŒè¯æ•°æ®çš„æ­£ç¡®æ€§
}
```
**ç¬¬äº”æ­¥**
æ ¡éªŒæ•°æ®
```
- (BOOL)validatePingResponsePacket:(NSMutableData *)packet sequenceNumber:(uint16_t *)sequenceNumberPtr 
```
è¿™é‡Œæ ¡éªŒ 

```swift
//æ˜¯å¦æœ‰icmpæŠ¥æ–‡
if (icmpHeaderOffset != NSNotFound) 
    //åˆ¤æ–­æ ¡éªŒå’Œ ipv6ä¸éœ€è¦
    if (receivedChecksum == calculatedChecksum) 
        //æŠ¥æ–‡ä¸­çš„è¿”å›æ˜¯å¦æ˜¯ è¿”å›ç±»å‹
        if ( (icmpPtr->type == ICMPv4TypeEchoReply)
            //å‘é€çš„Sequence æ˜¯å¦åŒ¹é…
            if ([self validateSequenceNumber:sequenceNumber])
```

ä¸­é—´ç©¿æ’çš„ä»£ç†å›è°ƒã€‚
å¤§ä½“çš„ping çš„æµç¨‹å°±å¾ˆæ¸…æ¥šäº†ã€‚ ä¸»è¦æ˜¯CFå±‚çš„API çœŸçš„è¶…çº§éš¾ç”¨ã€‚

## æ‹“å±• traceroute

![tracetoute](/img/in-post/ping/ping-4.png)

> TTLï¼ˆtime-to-liveï¼‰æ˜¯IPæ•°æ®åŒ…ä¸­çš„ä¸€ä¸ªå­—æ®µï¼Œå®ƒæŒ‡å®šäº†æ•°æ®åŒ…æœ€å¤šèƒ½ç»è¿‡å‡ æ¬¡è·¯ç”±å™¨ã€‚ä»æˆ‘ä»¬æºä¸»æœºå‘å‡ºå»çš„æ•°æ®åŒ…åœ¨åˆ°è¾¾ç›®çš„ä¸»æœºçš„è·¯ä¸Šè¦ç»è¿‡è®¸å¤šä¸ªè·¯ç”±å™¨çš„è½¬å‘ï¼Œåœ¨å‘é€æ•°æ®åŒ…çš„æ—¶å€™æºä¸»æœºä¼šè®¾ç½®ä¸€ä¸ªTTLçš„å€¼ï¼Œæ¯ç»è¿‡ä¸€ä¸ªè·¯ç”±å™¨TTLå°±ä¼šè¢«å‡å»ä¸€ï¼Œå½“TTLä¸º0çš„æ—¶å€™è¯¥æ•°æ®åŒ…ä¼šè¢«ç›´æ¥ä¸¢å¼ƒï¼ˆä¸å†ç»§ç»­è½¬å‘ï¼‰ï¼Œå¹¶å‘é€ä¸€ä¸ªè¶…æ—¶ICMPæŠ¥æ–‡ç»™æºä¸»æœºã€‚


å·®ä¸å¤šå’Œping ä¸åŒçš„æ˜¯

ç¬¬ä¸€
    åœ¨ipæŠ¥æ–‡æ®µä¸­æ·»åŠ ttl
```swift
setsockopt(CFSocketGetNative(self.socket), IPPROTO_IP, IP_TTL, &ttl, sizeof(ttl));
```
ç¬¬äºŒ
   å‘é€3æ¬¡icmp
```swift
sendto
sendto
sendto
```
## å°è£…å¥½äº†å·¥å…·
[QDNetDiagnostics!](https://github.com/dongqihouse/QDNetDiagnostics)

## Usage

```swift
self.netDiagnostics = [[QDNetDiagnostics alloc] initWithHostName:@"wwww.baidu.com"];
[self.netDiagnostics startDiagnosticAndNetInfo:^(NSString *info) {
NSLog(@"%@",info);
}];
```

## Result
![tracetoute](/img/in-post/ping/ping-5.png)





